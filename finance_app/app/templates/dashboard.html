{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
  .dashboard-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0;
  }

  .dashboard-header {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--glass-border);
    position: relative;
    overflow: hidden;
  }

  .dashboard-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--primary-gradient);
    opacity: 0.05;
    z-index: -1;
  }

  .dashboard-header h1 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 800;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
    letter-spacing: -0.3px;
  }

  .dashboard-header p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.95rem;
    font-weight: 500;
    opacity: 0.9;
  }

  .welcome-section {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 32px;
  }

  .welcome-text {
    flex: 1;
  }

  .welcome-greeting {
    font-size: 1.1rem;
    color: var(--text-muted);
    margin-bottom: 8px;
    font-weight: 500;
  }

  .current-time {
    font-size: 0.9rem;
    color: var(--text-muted);
    opacity: 0.7;
  }

  .quick-actions {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-top: 24px;
  }

  .quick-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 16px 24px;
    border-radius: 16px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .quick-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }

  .quick-btn:hover::before {
    left: 100%;
  }

  .quick-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(46, 204, 113, 0.4);
  }

  .quick-btn.voice {
    background: linear-gradient(135deg, #3498db, #2980b9);
    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
  }

  .quick-btn.voice:hover {
    box-shadow: 0 12px 35px rgba(52, 152, 219, 0.4);
  }

  .quick-btn i {
    font-size: 1.1rem;
  }

  .widgets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
  }

  .widget {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 32px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .widget::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
  }

  .widget:hover {
    transform: translateY(-5px);
    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
  }

  .widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .widget-title {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: #2c3e50;
  }

  .widget-link {
    color: #667eea;
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
    transition: color 0.3s ease;
  }

  .widget-link:hover {
    color: #764ba2;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }

  .stat-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #667eea, #764ba2);
  }

  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 8px;
    background: linear-gradient(45deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .stat-label {
    color: #666;
    font-size: 1rem;
    font-weight: 500;
  }

  .expense-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    margin-bottom: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 4px solid #667eea;
  }

  .expense-item:hover {
    transform: translateX(8px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }

  .expense-category {
    font-weight: 600;
    color: #2c3e50;
  }

  .expense-amount {
    font-weight: 700;
    color: #e74c3c;
  }

  .expense-date {
    font-size: 0.9rem;
    color: #666;
    margin-top: 4px;
  }

  .progress-bar {
    width: 100%;
    height: 12px;
    background: #e9ecef;
    border-radius: 6px;
    overflow: hidden;
    margin: 12px 0;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    border-radius: 6px;
    transition: width 0.6s ease;
  }

  .progress-text {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    font-size: 0.9rem;
    color: #666;
  }

  .goal-item {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .goal-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }

  .goal-title {
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 8px;
  }

  .goal-progress {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
  }

  .goal-amount {
    font-weight: 600;
    color: #667eea;
  }

  .ai-feature {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    text-align: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }

  .ai-feature:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }

  .ai-icon {
    font-size: 2rem;
    margin-bottom: 12px;
  }

  .ai-title {
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 8px;
  }

  .ai-description {
    color: #666;
    font-size: 0.9rem;
  }

  .loading-skeleton {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
  }

  .skeleton-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .fade-in {
    animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 768px) {
    .dashboard-container {
      padding: 16px;
    }

    .dashboard-header {
      flex-direction: column;
      text-align: center;
      gap: 20px;
    }

    .dashboard-header h1 {
      font-size: 2rem;
    }

    .quick-actions {
      justify-content: center;
    }

    .widgets-grid {
      grid-template-columns: 1fr;
    }

    .stats-grid {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }

    .widget {
      padding: 24px;
    }
  }
</style>

<div class="dashboard-container">
  <div class="dashboard-header">
    <div class="welcome-section">
      <div class="welcome-text">
        <div class="welcome-greeting" id="greeting">Ch√†o bu·ªïi s√°ng!</div>
        <h1>Dashboard</h1>
        <p id="user-info">Ch√†o m·ª´ng tr·ªü l·∫°i! Qu·∫£n l√Ω t√†i ch√≠nh th√¥ng minh v√† hi·ªáu qu·∫£.</p>
        <div class="current-time" id="current-time"></div>
      </div>
      <div class="quick-actions">
        <button onclick="quickAddExpense()" class="quick-btn">
          <i class="fas fa-plus"></i>
          <span>Chi ti√™u nhanh</span>
        </button>
        <button onclick="quickVoiceInput()" class="quick-btn voice">
          <i class="fas fa-microphone"></i>
          <span>Ghi √¢m</span>
        </button>
        <button onclick="window.location.href='/analysis'" class="quick-btn analysis">
          <i class="fas fa-chart-line"></i>
          <span>Ph√¢n t√≠ch</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div id="quick-stats" class="stats-grid"></div>

  <!-- Main Widgets -->
  <div class="widgets-grid">
    <!-- Recent Expenses -->
    <div class="widget">
      <div class="widget-header">
        <h3 class="widget-title">üí∞ Chi ti√™u g·∫ßn ƒë√¢y</h3>
        <a href="/expenses" class="widget-link">Xem t·∫•t c·∫£</a>
      </div>
      <div id="recent-expenses" style="max-height: 300px; overflow-y: auto;">
        <div class="loading-skeleton">
          <div class="skeleton-spinner"></div>
        </div>
      </div>
    </div>

    <!-- Budget Progress -->
    <div class="widget">
      <div class="widget-header">
        <h3 class="widget-title">üìä Ti·∫øn ƒë·ªô ng√¢n s√°ch</h3>
        <a href="/budget/edit" class="widget-link">Ch·ªânh s·ª≠a</a>
      </div>
      <div id="budget-progress" style="max-height: 300px; overflow-y: auto;">
        <div class="loading-skeleton">
          <div class="skeleton-spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Goals and AI Features -->
  <div class="widgets-grid">
    <!-- Financial Goals -->
    <div class="widget">
      <div class="widget-header">
        <h3 class="widget-title">üéØ M·ª•c ti√™u t√†i ch√≠nh</h3>
        <a href="/goals" class="widget-link">Xem t·∫•t c·∫£</a>
      </div>
      <div id="goals-widget" style="max-height: 300px; overflow-y: auto;">
        <div class="loading-skeleton">
          <div class="skeleton-spinner"></div>
        </div>
      </div>
    </div>

    <!-- AI Features -->
    <div class="widget">
      <div class="widget-header">
        <h3 class="widget-title">ü§ñ T√≠nh nƒÉng AI</h3>
        <span id="ai-quota" style="color: #666; font-size: 14px;">ƒêang t·∫£i...</span>
      </div>
      <div style="display: grid; gap: 12px;">
        <a href="/daily-chat-input" class="ai-feature">
          <div class="ai-icon">üí¨</div>
          <div class="ai-title">Nh·∫≠p chi ti√™u b·∫±ng AI</div>
          <div class="ai-description">G√µ ho·∫∑c n√≥i ƒë·ªÉ th√™m chi ti√™u</div>
        </a>
        <a href="/generate-plan" class="ai-feature">
          <div class="ai-icon">üìã</div>
          <div class="ai-title">L·∫≠p k·∫ø ho·∫°ch t√†i ch√≠nh</div>
          <div class="ai-description">AI gi√∫p t·∫°o k·∫ø ho·∫°ch chi ti√™u</div>
        </a>
      </div>
    </div>
  </div>

  <!-- Quick Access Grid -->
  <div class="widgets-grid">
    <a href="/expenses" class="widget" style="text-decoration: none; color: inherit;">
      <div style="text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 16px;">üí∞</div>
        <div class="widget-title">Chi ti√™u</div>
        <div style="color: #666; margin-top: 8px;">Qu·∫£n l√Ω chi ti√™u</div>
      </div>
    </a>
    <a href="/analysis" class="widget" style="text-decoration: none; color: inherit;">
      <div style="text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 16px;">üìä</div>
        <div class="widget-title">Ph√¢n t√≠ch</div>
        <div style="color: #666; margin-top: 8px;">B√°o c√°o & bi·ªÉu ƒë·ªì</div>
      </div>
    </a>
    <a href="/budget/edit" class="widget" style="text-decoration: none; color: inherit;">
      <div style="text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 16px;">üìã</div>
        <div class="widget-title">Ng√¢n s√°ch</div>
        <div style="color: #666; margin-top: 8px;">L·∫≠p k·∫ø ho·∫°ch chi ti√™u</div>
      </div>
    </a>
    <a href="/goals" class="widget" style="text-decoration: none; color: inherit;">
      <div style="text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 16px;">üéØ</div>
        <div class="widget-title">M·ª•c ti√™u</div>
        <div style="color: #666; margin-top: 8px;">Theo d√µi ti·∫øt ki·ªám</div>
      </div>
    </a>
    <a href="/categories" class="widget" style="text-decoration: none; color: inherit;">
      <div style="text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 16px;">üè∑Ô∏è</div>
        <div class="widget-title">Danh m·ª•c</div>
        <div style="color: #666; margin-top: 8px;">Qu·∫£n l√Ω ph√¢n lo·∫°i</div>
      </div>
    </a>
    <a href="/upgrade" class="widget" style="text-decoration: none; color: inherit;">
      <div style="text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 16px;">‚≠ê</div>
        <div class="widget-title">N√¢ng c·∫•p</div>
        <div style="color: #666; margin-top: 8px;">M·ªü kh√≥a t√≠nh nƒÉng</div>
      </div>
    </a>
  </div>
</div>

<script>
// Load user info and dashboard data
// Update greeting and time
function updateGreeting() {
  const hour = new Date().getHours();
  const greeting = document.getElementById('greeting');
  
  if (hour < 12) {
    greeting.textContent = 'Ch√†o bu·ªïi s√°ng!';
  } else if (hour < 18) {
    greeting.textContent = 'Ch√†o bu·ªïi chi·ªÅu!';
  } else {
    greeting.textContent = 'Ch√†o bu·ªïi t·ªëi!';
  }
}

function updateTime() {
  const now = new Date();
  const timeString = now.toLocaleString('vi-VN', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  document.getElementById('current-time').textContent = timeString;
}

(async () => {
    try {
        const r = await fetch('/auth/me');
        const d = await r.json();
        if (d.authenticated) {
            document.getElementById('user-info').textContent = `Xin ch√†o ${d.username} ‚Äî G√≥i: ${d.plan}, ƒêi·ªÉm: ${d.points}`;
            loadDashboardData();
        }
        
        // Update greeting and time
        updateGreeting();
        updateTime();
        
        // Update time every minute
        setInterval(updateTime, 60000);
    } catch (error) {
        console.error('Error loading user info:', error);
    }
})();

async function loadDashboardData() {
    await Promise.all([
        loadQuickStats(),
        loadRecentExpenses(),
        loadBudgetProgress(),
        loadGoals(),
        loadAIQuota()
    ]);
}

async function loadQuickStats() {
    try {
        const response = await fetch('/finance/expenses/summary');
        const data = await response.json();
        
        document.getElementById('quick-stats').innerHTML = `
            <div class="stat-card fade-in">
                <div class="stat-value">${data.total.toLocaleString('vi-VN')} VNƒê</div>
                <div class="stat-label">Chi ti√™u th√°ng n√†y</div>
            </div>
            <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                <div class="stat-value">${data.count}</div>
                <div class="stat-label">Giao d·ªãch</div>
            </div>
            <div class="stat-card fade-in" style="animation-delay: 0.4s;">
                <div class="stat-value">${Object.keys(data.by_category).length}</div>
                <div class="stat-label">Danh m·ª•c</div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading quick stats:', error);
    }
}

async function loadRecentExpenses() {
    try {
        const response = await fetch('/finance/expenses');
        const data = await response.json();
        
        const container = document.getElementById('recent-expenses');
        
        if (data.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Ch∆∞a c√≥ chi ti√™u n√†o</div>';
            return;
        }
        
        container.innerHTML = data.slice(0, 5).map(expense => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0;">
                <div>
                    <div style="font-weight: bold; color: #333;">${expense.category}</div>
                    <div style="color: #666; font-size: 14px;">${expense.date} ${expense.note ? ' - ' + expense.note : ''}</div>
                </div>
                <div style="font-weight: bold; color: #dc3545;">${expense.amount.toLocaleString('vi-VN')} VNƒê</div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading recent expenses:', error);
        document.getElementById('recent-expenses').innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">L·ªói t·∫£i d·ªØ li·ªáu</div>';
    }
}

async function loadBudgetProgress() {
    try {
        const response = await fetch('/finance/budget');
        const data = await response.json();
        
        const container = document.getElementById('budget-progress');
        
        if (!data.items || data.items.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Ch∆∞a c√≥ ng√¢n s√°ch</div>';
            return;
        }
        
        // Get current month expenses for comparison
        const expensesResponse = await fetch('/finance/expenses/summary');
        const expensesData = await expensesResponse.json();
        
        container.innerHTML = data.items.slice(0, 3).map(item => {
            const spent = expensesData.by_category[item.name] || 0;
            const percentage = Math.min(100, (spent / item.amount) * 100);
            const isOver = spent > item.amount;
            
            return `
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-weight: bold;">${item.name}</span>
                        <span style="color: ${isOver ? '#dc3545' : '#28a745'};">${spent.toLocaleString('vi-VN')} / ${item.amount.toLocaleString('vi-VN')} VNƒê</span>
                    </div>
                    <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: ${isOver ? '#dc3545' : '#28a745'}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">${percentage.toFixed(1)}%</div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading budget progress:', error);
        document.getElementById('budget-progress').innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">L·ªói t·∫£i d·ªØ li·ªáu</div>';
    }
}

async function loadGoals() {
    try {
        const response = await fetch('/finance/goals');
        const data = await response.json();
        
        const container = document.getElementById('goals-widget');
        
        if (!data.items || data.items.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Ch∆∞a c√≥ m·ª•c ti√™u n√†o</div>';
            return;
        }
        
        container.innerHTML = data.items.slice(0, 3).map(goal => {
            const percentage = Math.min(100, (goal.saved_amount / goal.target_amount) * 100);
            
            return `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: bold; margin-bottom: 4px;">${goal.title}</div>
                    <div style="background: #e9ecef; height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 4px;">
                        <div style="background: #007bff; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="font-size: 12px; color: #666;">${goal.saved_amount.toLocaleString('vi-VN')} / ${goal.target_amount.toLocaleString('vi-VN')} VNƒê (${percentage.toFixed(1)}%)</div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading goals:', error);
        document.getElementById('goals-widget').innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">L·ªói t·∫£i d·ªØ li·ªáu</div>';
    }
}

async function loadAIQuota() {
    try {
        const response = await fetch('/auth/me');
        const data = await response.json();
        
        if (data.authenticated) {
            const plan = data.plan || 'free';
            const limits = {
                'free': { ai: 5, voice: 3 },
                'pro_basic': { ai: 50, voice: 20 },
                'pro_plus': { ai: 200, voice: 100 },
                'enterprise': { ai: -1, voice: -1 }
            };
            
            const limit = limits[plan] || limits.free;
            const quotaText = limit.ai === -1 ? 'Kh√¥ng gi·ªõi h·∫°n' : `${limit.ai} l∆∞·ª£t/th√°ng`;
            
            document.getElementById('ai-quota').textContent = `Quota: ${quotaText}`;
        }
    } catch (error) {
        console.error('Error loading AI quota:', error);
    }
}

function quickAddExpense() {
    window.location.href = '/expenses';
}

function quickVoiceInput() {
    window.location.href = '/daily-chat-input';
}

// Add hover effects
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('a[href]');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>
{% endblock %}


